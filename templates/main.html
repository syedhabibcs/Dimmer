<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/noUiSlider/8.5.1/nouislider.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='epoch.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='significant.styles.epoch.css') }}">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    
    <style>
        .sliderCss {
            height: 300px;
            width: 90px;
        }

        #red .noUi-connect {
            background: #c0392b;
        }

        .noUi-vertical .noUi-handle {
            width: 100px;
            height: 30px;
        }

        p,
        li {
            font-size: 18px;
        }

        h2 {
            background-color: #9e8f96;
            color: antiquewhite;
            text-align: center;
        }

        .inputBar {
            font-size: 25px;
            text-align: center;
            width: 50%;
        }

        .inputBar[type=number]:focus {
            /* background-color: #3CBC8D; */
            /* color: white; */
            border: 3px solid rgb(29, 133, 151);
        }

        .odometer {
            padding: 10px;
            border: 5px solid rgb(255, 102, 0);
            margin: 0;
            font-size: 50px;
            text-align: center;
        }

        .showSchedule {
            list-style-type: square;
        }

        #success {
            background: #CCF5CC;
        }

        #failure {
            background: rgb(194, 67, 67);
            color: white;
        }
        .logo{
            float: right;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <h2 id=graphHeading class="text-center"></h2>
                <br>
                <div id="PowerBrightness" class="epoch" style="width: 1200px; height: 600px"></div>
                <div id="LuxBrightness" class="epoch" style="width: 1200px; height: 600px"></div>
                <div id="Lux" class="epoch my-colors" style="width: 1200px; height: 600px"></div>
            </div>
            <div class="col-md-4">
                <div class="row">
                    <div class="col-md-1">
                    </div>
                    <div class="col-md-11">
                        <h2>
                            Light Brighness
                        </h2>
                        <br>
                        <div class="row">
                            <div class="col-md-2"></div>
                            <div class="col-md-3">
                                <div id="slider" class="sliderCss noUi-connect"></div>
                            </div>
                            <br>
                            <br>
                            <br>
                            <div class="col-md-4">
                                <input id="input-format" class="inputBar" type="number" step="10">
                            </div>
                            <div class="col-md-5">
                            </div>

                        </div>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-1">
                    </div>
                    <div class="col-md-11">
                        <h2>
                            Lux Value
                        </h2>
                    
                        <div id="odometer" class="odometer"></div>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-5">
                <div class="row">
                    <div class="col-md-10">
                        <h2 class="text-left">
                            Create Action
                        </h2>

                        <div class="action">
                            Time:
                            <input type="time" id="myTime" step="10">
                            <div class="btn-group">
                                <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    +Current Time
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" data-type=1 href="#">+20s</a>
                                    <a class="dropdown-item" data-type=2 href="#">+30s</a>
                                    <a class="dropdown-item" data-type=3 href="#">+40s</a>
                                    <a class="dropdown-item" data-type=4 href="#">+50s</a>
                                    <a class="dropdown-item" data-type=5 href="#">+60s</a>
                                    <a class="dropdown-item" data-type=6 href="#">+70s</a>
                                    <a class="dropdown-item" data-type=7 href="#">+80s</a>
                                    <a class="dropdown-item" data-type=8 href="#">+90s</a>
                                    <a class="dropdown-item" data-type=9 href="#">+100s</a>
                                    <a class="dropdown-item" data-type=10 href="#">+110s</a>
                                    <a class="dropdown-item" data-type=11 href="#">+120s</a>
                                    <a class="dropdown-item" data-type=12 href="#">+130s</a>
                                    <a class="dropdown-item" data-type=13 href="#">+140s</a>
                                    <a class="dropdown-item" data-type=14 href="#">+150s</a>
                                    <a class="dropdown-item" data-type=15 href="#">+160s</a>
                                    <a class="dropdown-item" data-type=16 href="#">+170s</a>
                                    <a class="dropdown-item" data-type=17 href="#">+180s</a>
                                </div>
                            </div>
                            Intensity/Brightness:
                            <select id="intensity">
                                <option value="0">0 %</option>
                                <option value="1">10 %</option>
                                <option value="2">20 %</option>
                                <option value="3">30 %</option>
                                <option value="4">40 %</option>
                                <option value="5">50 %</option>
                                <option value="6">60 %</option>
                                <option value="7">70 %</option>
                                <option value="8">80 %</option>
                                <option value="9">90 %</option>
                                <option value="10">100 %</option>

                            </select>
                            <button onclick="scheduling()">Add Action</button>
                            <span id="success"></span>
                            <span id="failure"></span>

                            </p>
                        </div>
                    </div>
                    <div class="col-md-2">
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-10">
                        <div class="auto_manual">
                            <div class="row">
                                <div class="col-md-4">
                                    <p>Scheduling Type: </p>
                                    <input id="schedule_type" type="checkbox" checked data-toggle="toggle" data-on="Automatic" data-off="Manual" data-onstyle="success"
                                        data-offstyle="warning">
                                    </p>
                                </div>
                                <div class="col-md-8">
                                    <p>Graph Type: </p>
                                    <form id="GraphType">
                                        <label>
                                            <input type="radio" value=1 name="graphRadio" checked /> Reference Signal vs Actual Signal
                                        </label>
                                        <label>
                                            <input type="radio" value=2 name="graphRadio" /> Reference Signal vs Lux
                                        </label>
                                        <label>
                                            <input type="radio" value=3 name="graphRadio" /> Lux
                                        </label>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <h2 class="text-left">
                    Scheduled Events:
                </h2>
                <div class="showSchedule_class">
                    <ul id="scheduled_actions" class="showSchedule"></ul>
                    <br></br>
                </div>
            </div>
            <div class="logo col-md-4">
                <br><br><br><br>
                <div class="logo">
                    <img src="https://image.ibb.co/hfh11x/logo.jpg" alt="Logo can't be loaded">
                    <br></br>
                </div>
            </div>
        </div>
    </div>









    <!-- /////////////////////////////////////////////////////////////////////////////
    End of HTML///////////////////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////// -->


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="//cdn.bootcss.com/noUiSlider/8.5.1/nouislider.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='epoch.custom.js') }}"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <script>

        http_url = 'http://140.193.205.31:5000/'
        // http_url = 'http://192.168.0.17:5000/'
        // http_url = 'https://dimmerbrightness.herokuapp.com/'

        var xhr = new XMLHttpRequest();
        var data = new FormData();

        //--------------------------------------------------------------//
        //Slider--------------------------------------------------------//
        //--------------------------------------------------------------//

        var sliderFormat = document.getElementById('slider');

        noUiSlider.create(sliderFormat, {
            start: 0,
            step: 10,
            orientation: 'vertical',
            range: {
                'min': 0,
                'max': 100
            },
            format: {
                to: function (value) {
                    return value;
                },
                from: function (value) {
                    return value;
                }
            }
        });

        var inputFormat = document.getElementById('input-format');
        inputFormat.addEventListener('change', function () {
            sliderFormat.noUiSlider.set(100 - this.value);
        });

        sliderFormat.noUiSlider.on('update', function (values, handle) {
            inputFormat.value = 100 - values[handle];
        });

        sliderFormat.noUiSlider.on('set', function (values, handle) {
            $("#schedule_type").bootstrapToggle('off');
            xhr.open('POST', http_url.concat("signal/"), true);

            data.append('led_value', 100 - values[handle]);
            xhr.send(data);
            data.delete('led_value')
        });

        //--------------------------------------------------------------//
        //Events--------------------------------------------------------//
        //--------------------------------------------------------------//

        xhr = new XMLHttpRequest();
        var schedule_data = new FormData();
        //scheduling:
        function scheduling() {
            var dict = {};
            var time_input = document.getElementById("myTime").value;
            if ((time_input.split(":")).length == 2) {
                time_input = time_input.concat(":00");
            }

            var intensity = document.getElementById("intensity").selectedIndex;
            $("#schedule_type").bootstrapToggle('on');

            xhr.open('POST', http_url.concat("action/"), true);
            schedule_data.append('time', time_input);
            schedule_data.append('intensity', intensity);
            schedule_data.append('radio', true);

            xhr.send(schedule_data);
            schedule_data.delete('time')
            schedule_data.delete('intensity')
            schedule_data.delete('radio')

            xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    jsonDict = JSON.parse(this.responseText)
                    var isValid = jsonDict['valid'];
                    if (isValid) {

                        $('#success').fadeIn();
                        $('#success').text("Action created successfully!");
                        $('#success').fadeOut(5000);
                    }
                    else {
                        $('#failure').fadeIn();
                        $('#failure').text("Not a valid action!");
                        $('#failure').fadeOut(5000);
                    }
                    
                    $('#error_message').fadeIn().html("Action added successfully");
                    setTimeout(function () {
                        $('#error_message').fadeOut("slow");
                    }, 2000);

                    var actions = document.getElementById("scheduled_actions");
                    while (actions.firstChild) actions.removeChild(actions.firstChild);
                    for (var unixtime in jsonDict) {
                        if (unixtime != 'valid') {
                            var newDate = new Date();
                            newDate.setTime(unixtime * 1000);
                            var li = document.createElement("li");
                            li.textContent = "Time: " + newDate.toLocaleTimeString() + ", Intensity: " + jsonDict[unixtime];
                            actions.appendChild(li);
                        }
                    }
                }
            };
            xhttp.open("GET", http_url.concat("schedules/"), true);
            xhttp.send();
        }

        $(function poll() {
            var $meter_lux_value = $('#odometer');
            setTimeout(function () {
                $.ajax({
                    type: 'GET', url: http_url.concat("flux/"), success: function (server_lux_value) {
                        $meter_lux_value.text(parseFloat(server_lux_value['lux_value']).toFixed(2));
                        poll();
                    }, dataType: "json"
                });
            }, 1000);
        });

        //--------------------------------------------------------------//
        //Lux Chart-----------------------------------------------------//
        //--------------------------------------------------------------//

        var power = { label: 'power', values: [], range: [0, 100] };
        var brightness = { label: 'brightness', values: [], range: [0, 100] };
        var lux = { label: 'luxChart', values: [], range: [0, 13000] };
        var currentGraph = 1;
        $('#PowerBrightness').show()
        $('#LuxBrightness').hide()
        $('#graphHeading').text("Reference Signal (Blue-Solid) vs Feedback Signal (Orange-Dash)");


        $('#Lux').hide()

        var powerBrightnessData = [brightness, power];
        var powerBrightnessChart = $('#PowerBrightness').epoch({
            type: 'time.line',
            data: powerBrightnessData,
            range: {
                left: [0, 100]
            },
            axes: ['bottom', 'left'],
            ticks: { time: 30, left: 11 },
            windowSize: 180,
        });

        var luxBrightnessData = [brightness, lux];
        var luxBrightnessChart = $('#LuxBrightness').epoch({
            type: 'time.line',
            data: luxBrightnessData,
            range: {
                left: [0, 13000],
                right: [0, 100]
            },
            axes: ['bottom', 'left', 'right'],
            ticks: { time: 30, left: 13, right: 8 },
            windowSize: 180,
        });

        var luxData = [lux];
        var luxChart = $('#Lux').epoch({
            type: 'time.line',
            data: luxData,
            range: {
                left: [0, 13000]
            },
            axes: ['bottom', 'left'],
            ticks: { time: 30, left: 13 },
            windowSize: 180,
        });

        $('#GraphType input').on('change', function () {
            currentGraph = $("#GraphType input[type='radio']:checked").val();
            if (currentGraph == 1) {
                $('#PowerBrightness').show()
                $('#LuxBrightness').hide()
                $('#Lux').hide()
                $('#graphHeading').text("Reference Signal (Blue-Solid) vs Feedback Signal (Orange-Dash)");
            }
            else if (currentGraph == 2) {
                $('#PowerBrightness').hide()
                $('#LuxBrightness').show()
                $('#Lux').hide()
                $('#graphHeading').text("Reference Signal  (Blue-Solid) vs Lux (Orange-Dash)");
            }
            else if (currentGraph == 3) {
                $('#PowerBrightness').hide()
                $('#LuxBrightness').hide()
                $('#Lux').show()
                $('#graphHeading').text("Lux Feedback");
            }
        });

        $(function pollChart() {
            setTimeout(function () {
                $.ajax({
                    type: 'GET', url: http_url.concat('chart/'), success: function (data) {
                        //Update flux value
                        
                        powerBrightnessChart.push([{ time: data['seconds'][0], y: data['led_brightness'] }, { time: data['seconds'][0], y: data['power'] }]);
                        luxBrightnessChart.push([{ time: data['seconds'][0], y: data['led_brightness'] }, { time: data['seconds'][0], y: data['seconds'][1] }]);
                        luxChart.push([{ time: data['seconds'][0], y: data['seconds'][1] }]);
                        pollChart();
                    }, dataType: "json"
                });
            }, 1000);
        });


        $(".dropdown-menu a").click(function () {
            var type = $(this).data("type");

            var time_input = document.getElementById("myTime");
            var d = new Date();

            d.setSeconds(d.getSeconds() + ((type + 1) * 10));
            var h = d.getHours();
            var m = d.getMinutes();
            var s = d.getSeconds();

            if (h < 10) h = '0' + h;
            if (m < 10) m = '0' + m;
            if (s < 10) s = '0' + s;

            time_input.value = h + ':' + m + ':' + s;
        });

    </script>
</body>

</html>
